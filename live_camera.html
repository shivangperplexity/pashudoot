<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Breed Identifier</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #c3d9bc, #dff2e1, #a3c9a8);
            background-attachment: fixed;
            overflow-x: hidden;
            position: relative;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        .glass-container {
            backdrop-filter: blur(25px);
            background-color: rgba(255, 255, 255, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 0 40px 0 rgba(255, 255, 255, 0.5);
            transition: transform 0.3s ease-in-out;
        }

        .glass-card {
            backdrop-filter: blur(25px);
            background-color: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .lucid-sphere {
            position: relative;
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .lucid-sphere::before,
        .lucid-sphere::after,
        .lucid-sphere .inner-sphere {
            content: '';
            position: absolute;
            border-radius: 50%;
            background-color: rgba(128, 203, 196, 0.8);
            animation: pulse-wave 2s infinite;
        }

        .lucid-sphere .inner-sphere {
            width: 20px;
            height: 20px;
            z-index: 3;
            background-color: #80CBC4;
            animation: none;
        }

        .lucid-sphere::before {
            width: 40px;
            height: 40px;
            opacity: 0.6;
            animation-delay: 0s;
        }

        .lucid-sphere::after {
            width: 60px;
            height: 60px;
            opacity: 0.4;
            animation-delay: 0.5s;
        }

        @keyframes pulse-wave {
            0% { transform: scale(0.6); opacity: 0.8; }
            100% { transform: scale(1.2); opacity: 0; }
        }

        #camera-feed {
            width: 100%;
            height: auto;
            border-radius: 16px;
            overflow: hidden;
            transform: scaleX(-1);
        }

        #capture-canvas {
            display: none;
        }
        
        .drawer-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            z-index: 40;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }
        .drawer-overlay.open {
            opacity: 1;
            visibility: visible;
        }
        
        .drawer {
            position: fixed;
            top: 0;
            right: -100%;
            width: 80%;
            max-width: 300px;
            height: 100%;
            padding: 2rem;
            z-index: 50;
            transition: right 0.3s ease-in-out;
        }
        .drawer.open {
            right: 0;
        }
        .info-card {
            display: none;
        }
        .info-card.active {
            display: block;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen text-gray-700 p-4">

    <button id="hamburger-btn" class="fixed top-4 right-4 z-50 p-2 glass-card rounded-full shadow-lg">
        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path>
        </svg>
    </button>

    <div id="drawer-overlay" class="drawer-overlay"></div>
    <div id="drawer" class="drawer glass-container shadow-xl">
        <div class="flex justify-end">
            <button id="drawer-close-btn" class="p-2 text-gray-600 hover:text-gray-800 transition-colors">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <nav class="flex flex-col gap-4 mt-8">
            <a href="index.html" class="py-2 px-4 rounded-lg font-semibold text-gray-700 hover:bg-white/50 transition-colors">Home</a>
            <a href="live_camera.html" class="py-2 px-4 rounded-lg font-semibold text-gray-700 hover:bg-white/50 transition-colors">Detect from Live Camera</a>
            <a href="about.html" class="py-2 px-4 rounded-lg font-semibold text-gray-700 hover:bg-white/50 transition-colors">About</a>
            <a href="developers.html" class="py-2 px-4 rounded-lg font-semibold text-gray-700 hover:bg-white/50 transition-colors">Developers</a>
            <a href="api.html" class="py-2 px-4 rounded-lg font-semibold text-gray-700 hover:bg-white/50 transition-colors">API Documentation</a>
        </nav>
    </div>

    <div class="glass-container rounded-3xl p-6 w-full max-w-sm flex flex-col items-center">
        
        <header class="flex flex-col items-center mb-6 w-full">
            <h1 class="text-3xl font-bold text-center text-gray-800">Live Camera</h1>
            <p class="text-sm text-gray-500 text-center mt-2">Identify breeds in real-time!</p>
        </header>

        <div class="w-full relative glass-card rounded-2xl p-2 overflow-hidden">
            <video id="camera-feed" class="w-full h-auto" autoplay playsinline></video>
            <canvas id="capture-canvas" class="hidden"></canvas>
            <div id="no-camera" class="absolute inset-0 flex flex-col items-center justify-center text-center p-4 bg-gray-200/50 rounded-2xl">
                <p>Waiting for camera access...</p>
                <button id="start-camera" class="mt-4 px-4 py-2 bg-emerald-500 text-white font-semibold rounded-lg hover:bg-emerald-600 transition-colors">Start Camera</button>
            </div>
        </div>

        <div class="w-full mt-4 flex justify-around">
            <button id="switch-camera-btn" class="flex-1 mx-1 px-4 py-2 bg-gray-200/80 text-gray-700 font-semibold rounded-lg hover:bg-gray-300 transition-colors">
                Switch Camera
            </button>
        </div>

        <div id="live-status-box" class="w-full mt-6 p-4 glass-card rounded-2xl flex flex-col items-center hidden">
            <h2 class="text-lg font-semibold mb-2">Live Status</h2>
            <div id="lucid-sphere" class="lucid-sphere">
                <div class="inner-sphere"></div>
            </div>
            <p id="live-progress-text" class="text-sm text-gray-500 mt-4 text-center"></p>
            <div id="progress-bar-container" class="w-full h-2 bg-gray-200 rounded-full mt-4 overflow-hidden">
                <div id="progress-bar" class="h-full bg-emerald-500 transition-all duration-300 ease-in-out" style="width: 0%;"></div>
            </div>
        </div>

        <div id="live-results-box" class="w-full mt-6 p-4 glass-card rounded-2xl hidden">
            <h2 class="text-lg font-semibold mb-2 text-center">Live Identification</h2>
            <div class="mb-4">
                <span class="text-sm text-gray-500">Predicted Breed:</span>
                <p id="live-breed-name" class="text-xl font-bold text-gray-900">...</p>
            </div>
            <div class="mb-2">
                <span class="text-sm text-gray-500">Origin:</span>
                <p id="live-breed-origin" class="text-gray-800">...</p>
            </div>
            <div class="mb-2">
                <span class="text-sm text-gray-500">Physical Traits:</span>
                <p id="live-breed-traits" class="text-gray-800">...</p>
            </div>
            <div class="mb-2">
                <span class="text-sm text-gray-500">Temperament:</span>
                <p id="live-breed-temperament" class="text-gray-800">...</p>
            </div>
            <div class="mb-4">
                <span class="text-sm text-gray-500">Milk Yield:</span>
                <p id="live-breed-milk-yield" class="text-gray-800">...</p>
            </div>
        </div>
        
    </div>

    <script>
        const video = document.getElementById('camera-feed');
        const canvas = document.getElementById('capture-canvas');
        const startCameraBtn = document.getElementById('start-camera');
        const switchCameraBtn = document.getElementById('switch-camera-btn');
        const noCameraSection = document.getElementById('no-camera');
        const liveStatusBox = document.getElementById('live-status-box');
        const liveProgressText = document.getElementById('live-progress-text');
        const liveResultsBox = document.getElementById('live-results-box');
        const liveBreedName = document.getElementById('live-breed-name');
        const liveBreedOrigin = document.getElementById('live-breed-origin');
        const liveBreedTraits = document.getElementById('live-breed-traits');
        const liveBreedTemperament = document.getElementById('live-breed-temperament');
        const liveBreedMilkYield = document.getElementById('live-breed-milk-yield');
        const progressBarContainer = document.getElementById('progress-bar-container');
        const progressBar = document.getElementById('progress-bar');
        const hamburgerBtn = document.getElementById('hamburger-btn');
        const drawer = document.getElementById('drawer');
        const drawerOverlay = document.getElementById('drawer-overlay');
        const drawerCloseBtn = document.getElementById('drawer-close-btn');

        let currentStream = null;
        let isFrontCamera = true;
        let breedResponses = [];
        let breedPromises = [];
        const requiredResponses = 15;
        let collecting = false;
        let lastApiCallTime = 0;
        const apiCallInterval = 750; // Milliseconds

        const breedInfo = {
            "Pandharpuri": { origin: "Maharashtra, India", temperament: "Docile and resilient", physicalTraits: "Medium-sized, black-grey coat, twisted horns. Known for their milking ability and adaptability to hot climate.", milkYield: "5-8 L/day", type: "Cow" },
            "Barbari": { origin: "Rajasthan, India", temperament: "Friendly and social", physicalTraits: "Small-sized, compact body with a distinctive white coat with brown patches. Horns are small and spiraled.", milkYield: "1-2 L/day", type: "Goat" },
            "Black Bengal": { origin: "West Bengal, India", temperament: "Hardy and non-aggressive", physicalTraits: "Small and short-legged, with a black coat. Highly fertile and known for their meat quality.", milkYield: "1-2 L/day", type: "Goat" },
            "Bargur": { origin: "Tamil Nadu, India", temperament: "Active and quick-footed", physicalTraits: "Medium-sized, brown or grey coat with white markings. Known for speed and endurance.", milkYield: "3-5 L/day", type: "Cow" },
            "Deoni": { origin: "Maharashtra/Karnataka/Andhra Pradesh", temperament: "Calm and docile", physicalTraits: "Large-sized, white or black-spotted coat. Prominent forehead and long ears. A dual-purpose breed.", milkYield: "3-8 L/day", type: "Cow" },
            "Gir": { origin: "Gujarat, India", temperament: "Gentle and calm", physicalTraits: "Large-sized, red or spotted coat. Distinctive rounded forehead and long, floppy ears. Known for high-quality A2 milk.", milkYield: "10-15 L/day", type: "Cow" },
            "Guzerat": { origin: "Gujarat, India", temperament: "Calm and quiet", physicalTraits: "Large-sized, grey or white coat. Very prominent horns that curve upward. A powerful draught and dairy breed.", milkYield: "6-10 L/day", type: "Cow" },
            "Hallikar": { origin: "Karnataka, India", temperament: "Strong and spirited", physicalTraits: "Lean, muscular body with a dark grey or black coat. Long, pointed horns that curve backwards. Known for draught power.", milkYield: "2-5 L/day", type: "Cow" },
            "Holstein": { origin: "Netherlands", temperament: "Gentle and quiet", physicalTraits: "Very large, black and white patterned coat. Recognizable by their massive size and prominent udder. The world's leading dairy breed.", milkYield: "20-30 L/day", type: "Cow" },
            "Jaffrabadi": { origin: "Gujarat, India", temperament: "Bold and powerful", physicalTraits: "Massive body, black coat, and a very large, bulging forehead. Horns are heavy and droop downwards. Known for high milk fat content.", milkYield: "6-10 L/day", type: "Buffalo" },
            "Jersey": { origin: "Jersey Island, UK", temperament: "Docile and curious", physicalTraits: "Small-sized, fawn-colored coat. Known for their large eyes and refined features. They produce milk with a high butterfat content.", milkYield: "12-20 L/day", type: "Cow" },
            "Murrah": { origin: "Haryana, India", temperament: "Placid and easy to manage", physicalTraits: "Jet black coat, short, tightly curved horns. Known for their high milk yield and adaptability.", milkYield: "8-12 L/day", type: "Buffalo" },
            "Nili Ravi": { origin: "Pakistan", temperament: "Calm and gentle", physicalTraits: "Usually black coat, often with white markings on the forehead, face, and legs. Distinctive curled horns. Known for high milk production.", milkYield: "7-12 L/day", type: "Buffalo" },
            "Red Sindhi": { origin: "Sindh (Pakistan/India)", temperament: "Friendly and easy to handle", physicalTraits: "Medium-sized, deep red coat. Prominent forehead and long, droopy ears. A hardy and heat-tolerant dairy breed.", milkYield: "8-12 L/day", type: "Cow" },
            "Sahiwal": { origin: "Punjab region", temperament: "Calm and docile", physicalTraits: "Medium-sized, reddish-brown coat. Characterized by a loose dewlap and long ears. One of the best dairy breeds in India.", milkYield: "12-18 L/day", type: "Cow" },
            "Sirohi": { origin: "Rajasthan, India", temperament: "Hardy and adaptable", physicalTraits: "Medium-sized, with a brown coat speckled with white patches. Ears are long and leaf-like. A dual-purpose goat known for meat and milk.", milkYield: "1-2 L/day", type: "Goat" },
            "Not Identified": { origin: "-", temperament: "-", physicalTraits: "-", milkYield: "-", type: "N/A" }
        };

        const getMostFrequent = (arr) => {
            if (arr.length === 0) return "Not Identified";
            const counts = {};
            let maxCount = 0;
            let mostFrequent = arr[0];
            for (const item of arr) {
                counts[item] = (counts[item] || 0) + 1;
                if (counts[item] > maxCount) {
                    maxCount = counts[item];
                    mostFrequent = item;
                }
            }
            return mostFrequent;
        };

        const startCamera = async (constraints) => {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
            }
            try {
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                currentStream = stream;
                noCameraSection.classList.add('hidden');
                liveStatusBox.classList.remove('hidden');
                startAnalysis();
            } catch (err) {
                console.error("Camera access denied:", err);
                noCameraSection.classList.remove('hidden');
                liveProgressText.textContent = "Camera access denied. Please allow camera permissions.";
            }
        };

        const switchCamera = () => {
            isFrontCamera = !isFrontCamera;
            startCamera({ video: { facingMode: isFrontCamera ? 'user' : 'environment' } });
            video.style.transform = isFrontCamera ? 'scaleX(-1)' : 'scaleX(1)';
        };

        switchCameraBtn.addEventListener('click', switchCamera);
        startCameraBtn.addEventListener('click', () => {
            startCamera({ video: { facingMode: 'environment' } });
            video.style.transform = 'scaleX(1)';
        });

        const startAnalysis = () => {
            if (collecting) return;
            collecting = true;
            breedPromises = [];
            liveResultsBox.classList.add('hidden');
            progressBarContainer.classList.remove('hidden');
            liveProgressText.textContent = "Searching for a cattle...";
            lastApiCallTime = 0;

            const animateLoop = (timestamp) => {
                if (!collecting) return;
                
                if (timestamp - lastApiCallTime > apiCallInterval) {
                    lastApiCallTime = timestamp;
                    analyzeFrame();
                }

                requestAnimationFrame(animateLoop);
            };
            
            const analyzeFrame = async () => {
                if (video.readyState !== 4 || !collecting) return;
                
                if (breedPromises.length >= requiredResponses) {
                    return;
                }

                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

                canvas.toBlob(async (blob) => {
                    const detectFormData = new FormData();
                    detectFormData.append("file", blob, "camera-frame.jpg");

                    try {
                        const detectResp = await fetch("https://rjsmoke00-cd.hf.space/predict", { method: "POST", body: detectFormData });
                        const detectData = await detectResp.json();
                        const detectLabel = (detectData && detectData.prediction) ? detectData.prediction : "Not Identified";

                        if (detectLabel === "LABEL_1") {
                            const breedFormData = new FormData();
                            breedFormData.append("file", blob, "camera-frame.jpg");

                            const breedPromise = fetch("https://Shivangguptasih-v2.hf.space/predict", { method: "POST", body: breedFormData })
                                .then(response => response.json())
                                .then(breedData => {
                                    return breedData?.prediction?.toLowerCase() || "not identified";
                                })
                                .catch(e => {
                                    console.error("Creto.ai API error:", e);
                                    return "not identified";
                                });
                            
                            breedPromises.push(breedPromise);

                            const progress = Math.min(breedPromises.length, requiredResponses);
                            liveProgressText.textContent = `Uploading ${progress}/${requiredResponses} frames...`;
                            progressBar.style.width = `${(progress / requiredResponses) * 100}%`;

                            if (breedPromises.length >= requiredResponses) {
                                liveProgressText.textContent = "Analyzing results...";
                                progressBarContainer.classList.add('hidden');
                                await Promise.all(breedPromises).then(results => {
                                    const finalBreed = getMostFrequent(results.filter(r => r !== "not identified"));
                                    displayResult(finalBreed);
                                    liveStatusBox.classList.add('hidden');
                                    collecting = false;
                                });
                            }
                        } else {
                            liveProgressText.textContent = "Searching for a cattle...";
                        }
                    } catch (err) {
                        console.error("CattleLense API error:", err);
                        liveProgressText.textContent = "Analysis failed. Retrying...";
                    }
                }, 'image/jpeg');
            };

            requestAnimationFrame(animateLoop);
        };

        const displayResult = (breedName) => {
            const formattedBreed = breedName.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
            const info = breedInfo[formattedBreed] || breedInfo["Not Identified"];
            
            liveBreedName.textContent = formattedBreed;
            liveBreedOrigin.textContent = info.origin;
            liveBreedTraits.textContent = info.physicalTraits;
            liveBreedTemperament.textContent = info.temperament;
            liveBreedMilkYield.textContent = info.milkYield;

            liveResultsBox.classList.remove('hidden');
        };

        window.onload = () => {
            startCamera({ video: { facingMode: 'environment' } });
            video.style.transform = 'scaleX(1)';
        };

        hamburgerBtn.addEventListener('click', () => {
            drawer.classList.add('open');
            drawerOverlay.classList.add('open');
        });
        drawerCloseBtn.addEventListener('click', () => {
            drawer.classList.remove('open');
            drawerOverlay.classList.remove('open');
        });
        drawerOverlay.addEventListener('click', () => {
            drawer.classList.remove('open');
            drawerOverlay.classList.remove('open');
        });

    </script>

</body>
</html>
