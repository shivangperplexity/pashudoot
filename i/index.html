<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cattle Breed Live Scanner</title>
<style>
body{margin:0;font-family:sans-serif;display:flex;flex-direction:column;align-items:center;background:#f2f2f2;padding:10px;}
h1{color:#6a1b9a;margin:10px 0;text-align:center;}
#cameraContainer{position:relative;width:100%;max-width:640px;background:#000;border-radius:16px;overflow:hidden;}
video{width:100%;height:auto;border-radius:16px;transform:scaleX(-1);}
canvas{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;}
#logs{width:100%;max-width:640px;background:#fff;padding:10px;margin-top:10px;border-radius:12px;height:120px;overflow-y:auto;font-family:monospace;}
#result{display:none;width:100%;max-width:640px;background:#fff;border-radius:16px;margin-top:10px;box-shadow:0 6px 16px rgba(106,27,154,0.25);}
.result-header{background:linear-gradient(135deg,#6a1b9a,#d81b60);color:#fff;font-weight:700;font-size:1.4rem;padding:12px;text-align:center;border-radius:16px 16px 0 0;}
.result-body{padding:16px 20px;}
.result-body p{margin:6px 0;}
#scanAgain{margin:10px auto;display:block;padding:10px 20px;background:#6a1b9a;color:#fff;border:none;border-radius:12px;cursor:pointer;font-size:1rem;}
</style>
</head>
<body>
<h1>Cattle Breed Live Scanner</h1>
<div id="cameraContainer">
  <video id="video" autoplay playsinline muted></video>
  <canvas id="overlay"></canvas>
</div>
<div id="logs">Initializing camera...</div>
<div id="result">
  <div class="result-header" id="resHeader"></div>
  <div class="result-body">
    <p id="resOrigin"></p>
    <p id="resLifespan"></p>
    <p id="resMilk"></p>
    <p id="resDesc"></p>
  </div>
  <button id="scanAgain">Scan Again</button>
</div>

<script>
// Elements
const video = document.getElementById("video");
const canvas = document.getElementById("overlay");
const ctx = canvas.getContext("2d");
const logs = document.getElementById("logs");
const resultDiv = document.getElementById("result");
const resHeader = document.getElementById("resHeader");
const resOrigin = document.getElementById("resOrigin");
const resLifespan = document.getElementById("resLifespan");
const resMilk = document.getElementById("resMilk");
const resDesc = document.getElementById("resDesc");
const scanAgainBtn = document.getElementById("scanAgain");

// Control variables
let scanning = true;
let requestInProgress = false;

// Helper log
function log(msg){
    logs.innerHTML += msg+"<br>";
    logs.scrollTop = logs.scrollHeight;
}

// Breed Info mapping
const breedInfo = {
  "Barbari Goat": {origin:"Rajasthan, India", lifespan:"10-12 years", milkYield:"1-2 L/day", description:"Small-sized dual-purpose goat."},
  "Bargur Cow": {origin:"Tamil Nadu, India", lifespan:"15-18 years", milkYield:"3-5 L/day", description:"Draught cattle from hilly areas."},
  "Bhadawari Buffalo": {origin:"U.P., India", lifespan:"16-20 years", milkYield:"6-10 L/day", description:"Milk with high fat content."},
  "Black Bengal Goat": {origin:"West Bengal, India", lifespan:"8-12 years", milkYield:"1-2 L/day", description:"Known for meat and skin quality."},
  "Hallikar Cow": {origin:"Karnataka, India", lifespan:"15-20 years", milkYield:"2-5 L/day", description:"Strong draught breed."},
  "Hariana Cow": {origin:"Haryana, India", lifespan:"16-20 years", milkYield:"6-10 L/day", description:"Dairy breed with high milk yield."},
  "Holstein Friesian Cow": {origin:"Netherlands", lifespan:"18-22 years", milkYield:"20-30 L/day", description:"World's leading dairy breed."},
  "Jamunapari Goat": {origin:"U.P., India", lifespan:"10-12 years", milkYield:"2-3 L/day", description:"Large goat with high milk yield."},
  "Nagori Goat": {origin:"Rajasthan, India", lifespan:"12-15 years", milkYield:"1-2 L/day", description:"Good draught goat breed."},
  "Osmanabadi Goat": {origin:"Maharashtra, India", lifespan:"10-12 years", milkYield:"1-2 L/day", description:"Hardy and disease-resistant goat."},
  "Tharparkar Cow": {origin:"Rajasthan, India", lifespan:"15-18 years", milkYield:"10-12 L/day", description:"Dual-purpose heat-tolerant cow."},
  "Deoni Cow": {origin:"Maharashtra/Karnataka/Andhra Pradesh", lifespan:"12-15 years", milkYield:"3-8 L/day", description:"Dual-purpose cow breed."},
  "Gir Cow": {origin:"Gujarat, India", lifespan:"12-15 years", milkYield:"10-15 L/day", description:"High-quality A2 milk producer."},
  "Guzerat Cow": {origin:"Gujarat, India", lifespan:"15-18 years", milkYield:"6-10 L/day", description:"Draught and dairy breed."},
  "Jaffrabadi Buffalo": {origin:"Gujarat, India", lifespan:"14-18 years", milkYield:"6-10 L/day", description:"Large buffalo, high milk yield."},
  "Jersey Cow": {origin:"Jersey Island, UK", lifespan:"18-22 years", milkYield:"12-20 L/day", description:"Rich milk producer."},
  "Mehsana Buffalo": {origin:"Gujarat, India", lifespan:"16-20 years", milkYield:"8-12 L/day", description:"Good dairy buffalo."},
  "Murrah Buffalo": {origin:"Haryana, India", lifespan:"16-20 years", milkYield:"8-12 L/day", description:"High milk-producing buffalo."},
  "Nili Ravi Buffalo": {origin:"Pakistan", lifespan:"14-18 years", milkYield:"7-12 L/day", description:"Famous dairy buffalo breed."},
  "Pandharpuri Cow": {origin:"Maharashtra, India", lifespan:"12-15 years", milkYield:"5-8 L/day", description:"Adapted to drought regions."},
  "Rathi Cow": {origin:"Rajasthan, India", lifespan:"15-20 years", milkYield:"8-10 L/day", description:"Heat-tolerant dairy cow."},
  "Red Sindhi Cow": {origin:"Sindh (Pakistan/India)", lifespan:"12-15 years", milkYield:"8-12 L/day", description:"Good milk yield, heat-tolerant."},
  "Sahiwal Cow": {origin:"Punjab region", lifespan:"12-15 years", milkYield:"12-18 L/day", description:"Heat-tolerant dairy breed."},
  "Sirohi Cow": {origin:"Rajasthan, India", lifespan:"10-12 years", milkYield:"1-2 L/day", description:"Good meat and milk producer."},
  "Vechur Cow": {origin:"Kerala, India", lifespan:"15-18 years", milkYield:"2-3 L/day", description:"Smallest cow breed, hardy."},
  "Not Identified": {origin:"-", lifespan:"-", milkYield:"-", description:"Breed could not be identified."}
};

// Camera setup
async function startCamera(){
    try{
        const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}, audio:false});
        video.srcObject = stream;
        await video.play();
        resizeCanvas();
        log("Camera started.");
    }catch(e){
        log("Camera error: "+e.message);
    }
}

function resizeCanvas(){
    canvas.width = video.videoWidth || 640;
    canvas.height = video.videoHeight || 480;
}

// Draw detection box
function drawBox(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    if(!scanning) return;
    const w = canvas.width*0.6;
    const h = canvas.height*0.5;
    const x = (canvas.width-w)/2;
    const y = (canvas.height-h)/2;
    ctx.strokeStyle = "#6a1b9a";
    ctx.lineWidth = 4;
    ctx.strokeRect(x,y,w,h);
}

// Preprocess frame
function getFrameBlob(){
    const tempCanvas = document.createElement("canvas");
    tempCanvas.width = 300;
    tempCanvas.height = 300 * (video.videoHeight/video.videoWidth);
    const tCtx = tempCanvas.getContext("2d");
    tCtx.drawImage(video,0,0,tempCanvas.width,tempCanvas.height);
    return new Promise(resolve=>tempCanvas.toBlob(resolve,"image/jpeg",0.7));
}

// Real API calls
async function detectionAPI(blob){
    const form = new FormData();
    form.append("file", blob);
    const resp = await fetch("https://rjsmoke00-cd.hf.space/predict", {method:"POST", body:form});
    return resp.json();
}

async function breedAPI(blob){
    const form = new FormData();
    form.append("file", blob);
    const resp = await fetch("https://Shivangguptasih-breedclassification.hf.space/predict", {method:"POST", body:form});
    return resp.json();
}

// Analyze frame
async function analyzeFrame(){
    if(!scanning || requestInProgress) return;
    requestInProgress = true;
    const blob = await getFrameBlob();
    try{
        const detectData = await detectionAPI(blob);
        const label = detectData.prediction || "LABEL_0";
        log("Detection: "+label);
        if(label === "LABEL_1"){
            const breedData = await breedAPI(blob);
            const breedName = breedData.prediction || "Not Identified";
            showResult(breedName);
        }
    }catch(e){
        log("API Error: "+e.message);
    }finally{
        requestInProgress = false;
    }
}

// Show result and freeze frame
function showResult(breedName){
    scanning = false;
    resultDiv.style.display = "block";
    const info = breedInfo[breedName] || breedInfo["Not Identified"];
    resHeader.textContent = `✅ Detected → Breed: ${breedName}`;
    resOrigin.textContent = `Origin: ${info.origin}`;
    resLifespan.textContent = `Lifespan: ${info.lifespan}`;
    resMilk.textContent = `Milk Yield: ${info.milkYield}`;
    resDesc.textContent = `About: ${info.description}`;
}

// Scan again button
scanAgainBtn.addEventListener("click",()=>{
    scanning = true;
    resultDiv.style.display = "none";
});

// Main loop
function mainLoop(){
    drawBox();
    if(scanning) analyzeFrame();
    requestAnimationFrame(mainLoop);
}

startCamera().then(()=>mainLoop());
window.addEventListener("resize", resizeCanvas);

</script>
</body>
</html>
