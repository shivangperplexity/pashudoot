<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Debug Cattle Scanner</title>
<style>
body{margin:0; font-family:sans-serif; display:flex; flex-direction:column; align-items:center; background:#f2f2f2; padding:10px;}
h1{color:#6a1b9a; margin:10px 0;}
#cameraContainer{position:relative; width:100%; max-width:640px; background:#000; border-radius:16px;}
video{width:100%; height:auto; border-radius:16px; transform:scaleX(-1);}
canvas{position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none;}
#logs{width:100%; max-width:640px; background:#fff; padding:10px; margin-top:10px; border-radius:12px; height:120px; overflow-y:auto; font-family:monospace;}
#result{display:none; width:100%; max-width:640px; background:#fff; border-radius:16px; margin-top:10px; box-shadow:0 6px 16px rgba(106,27,154,0.25);}
.result-header{background:linear-gradient(135deg,#6a1b9a,#d81b60); color:#fff; font-weight:700; font-size:1.4rem; padding:12px; text-align:center; border-radius:16px 16px 0 0;}
.result-body{padding:16px 20px;}
.result-body p{margin:6px 0;}
#scanAgain{margin:10px auto; display:block; padding:10px 20px; background:#6a1b9a; color:#fff; border:none; border-radius:12px; cursor:pointer;}
</style>
</head>
<body>
<h1>Debug Cattle Scanner</h1>
<div id="cameraContainer">
  <video id="video" autoplay playsinline muted></video>
  <canvas id="overlay"></canvas>
</div>
<div id="logs">Initializing camera...</div>
<div id="result">
  <div class="result-header" id="resHeader"></div>
  <div class="result-body">
    <p id="resOrigin"></p>
    <p id="resLifespan"></p>
    <p id="resMilk"></p>
    <p id="resDesc"></p>
  </div>
  <button id="scanAgain">Scan Again</button>
</div>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("overlay");
const ctx = canvas.getContext("2d");
const logs = document.getElementById("logs");
const resultDiv = document.getElementById("result");
const resHeader = document.getElementById("resHeader");
const resOrigin = document.getElementById("resOrigin");
const resLifespan = document.getElementById("resLifespan");
const resMilk = document.getElementById("resMilk");
const resDesc = document.getElementById("resDesc");
const scanAgainBtn = document.getElementById("scanAgain");

let scanning = true;
let requestInProgress = false;

// Simple log helper
function log(msg){
    logs.innerHTML += msg+"<br>";
    logs.scrollTop = logs.scrollHeight;
}

// Start camera
async function startCamera(){
    try{
        const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}, audio:false});
        video.srcObject = stream;
        await video.play();
        resizeCanvas();
        log("Camera started successfully.");
    }catch(e){
        log("Camera error: "+e.message);
    }
}

function resizeCanvas(){
    canvas.width = video.videoWidth || 640;
    canvas.height = video.videoHeight || 480;
}

// Draw overlay box
function drawBox(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    if(!scanning) return;
    const w = canvas.width*0.6;
    const h = canvas.height*0.5;
    const x = (canvas.width-w)/2;
    const y = (canvas.height-h)/2;
    ctx.strokeStyle = "#6a1b9a";
    ctx.lineWidth = 4;
    ctx.strokeRect(x,y,w,h);
}

// Preprocess frame
function getFrameBlob(){
    const tempCanvas = document.createElement("canvas");
    tempCanvas.width = 300;
    tempCanvas.height = 300 * (video.videoHeight/video.videoWidth);
    const tCtx = tempCanvas.getContext("2d");
    tCtx.drawImage(video,0,0,tempCanvas.width,tempCanvas.height);
    return new Promise(resolve=>tempCanvas.toBlob(resolve,"image/jpeg",0.7));
}

// Fake API functions for testing
async function detectionAPI(blob){
    log("Fake detection request sent.");
    return new Promise(res=>{
        setTimeout(()=>res({prediction:"LABEL_1"}),100);
    });
}
async function breedAPI(blob){
    log("Fake breed request sent.");
    return new Promise(res=>{
        setTimeout(()=>res({prediction:"Barbari Goat"}),100);
    });
}

// Analyze frame
async function analyzeFrame(){
    if(!scanning || requestInProgress) return;
    requestInProgress = true;
    const blob = await getFrameBlob();

    try{
        const detectData = await detectionAPI(blob);
        const label = detectData.prediction || "LABEL_0";
        log("Detection: "+label);
        if(label === "LABEL_1"){
            const breedData = await breedAPI(blob);
            const breedName = breedData.prediction || "Not Identified";
            showResult(breedName);
        }
    }catch(e){
        log("API Error: "+e.message);
    }finally{
        requestInProgress = false;
    }
}

// Show result
function showResult(breedName){
    scanning = false;
    resultDiv.style.display = "block";
    resHeader.textContent = `✅ Detected → Breed: ${breedName}`;
    resOrigin.textContent = `Origin: Demo`;
    resLifespan.textContent = `Lifespan: Demo`;
    resMilk.textContent = `Milk Yield: Demo`;
    resDesc.textContent = `About: Demo description`;
}

// Scan again
scanAgainBtn.addEventListener("click",()=>{
    scanning = true;
    resultDiv.style.display = "none";
});

function mainLoop(){
    drawBox();
    if(scanning) analyzeFrame();
    requestAnimationFrame(mainLoop);
}

startCamera().then(()=>mainLoop());
window.addEventListener("resize", resizeCanvas);

</script>
</body>
</html>
