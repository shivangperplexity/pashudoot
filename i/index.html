<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cattle & Goat Live Scanner</title>
<style>
body { font-family: 'Inter', sans-serif; display:flex; flex-direction:column; align-items:center; justify-content:flex-start; margin:0; padding:20px; background:#f0f4f8; }
h1 { color:#6a1b9a; text-align:center; }
#camera-container { position:relative; width:90%; max-width:640px; margin-top:10px; }
video { width:100%; border-radius:12px; }
canvas { display:none; }
#result { margin-top:20px; background:#fff; padding:16px; border-radius:12px; width:90%; max-width:640px; box-shadow:0 4px 12px rgba(0,0,0,0.2); display:none; }
#result p { margin:5px 0; }
#scan-again { margin-top:12px; padding:8px 16px; border:none; border-radius:8px; background:#6a1b9a; color:#fff; cursor:pointer; font-weight:600; display:none; }
#logs { margin-top:12px; width:90%; max-width:640px; height:120px; overflow-y:auto; background:#222; color:#0f0; font-family:monospace; padding:8px; border-radius:8px; font-size:0.85rem; }
</style>
</head>
<body>
<h1>Cattle & Goat Live Scanner</h1>

<div id="camera-container">
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas"></canvas>
</div>

<div id="result">
  <h3 id="breed-name"></h3>
  <p id="origin"></p>
  <p id="lifespan"></p>
  <p id="milkYield"></p>
  <p id="description"></p>
</div>

<button id="scan-again">Scan Again</button>

<div id="logs"></div>

<script>
const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const resultDiv = document.getElementById("result");
const breedNameEl = document.getElementById("breed-name");
const originEl = document.getElementById("origin");
const lifespanEl = document.getElementById("lifespan");
const milkYieldEl = document.getElementById("milkYield");
const descriptionEl = document.getElementById("description");
const scanAgainBtn = document.getElementById("scan-again");
const logs = document.getElementById("logs");

let requestInProgress = false;

// Correct class order
const CLASSES = ['pandharpuri','barbari','black bengal','burgur','deoni','gir','guzerat','halikar','holstein','jaffarbadi','jersey','murrah','nili ravi','red sindhi','sahiwal','sirohi'];

// Breed info
const breedInfo = {
  "barbari": {fullName:"Barbari Goat", origin:"Rajasthan, India", lifespan:"10-12 years", milkYield:"1-2 L/day", description:"Small-sized dual-purpose goat."},
  "burgur": {fullName:"Bargur Cow", origin:"Tamil Nadu, India", lifespan:"15-18 years", milkYield:"3-5 L/day", description:"Draught cattle from hilly areas."},
  "black bengal": {fullName:"Black Bengal Goat", origin:"West Bengal, India", lifespan:"8-12 years", milkYield:"1-2 L/day", description:"Known for meat and skin quality."},
  "halikar": {fullName:"Hallikar Cow", origin:"Karnataka, India", lifespan:"15-20 years", milkYield:"2-5 L/day", description:"Strong draught breed."},
  "deoni": {fullName:"Deoni Cow", origin:"Maharashtra/Karnataka/Andhra Pradesh", lifespan:"12-15 years", milkYield:"3-8 L/day", description:"Dual-purpose cow breed."},
  "gir": {fullName:"Gir Cow", origin:"Gujarat, India", lifespan:"12-15 years", milkYield:"10-15 L/day", description:"High-quality A2 milk producer."},
  "guzerat": {fullName:"Guzerat Cow", origin:"Gujarat, India", lifespan:"15-18 years", milkYield:"6-10 L/day", description:"Draught and dairy breed."},
  "holstein": {fullName:"Holstein Friesian Cow", origin:"Netherlands", lifespan:"18-22 years", milkYield:"20-30 L/day", description:"World's leading dairy breed."},
  "jaffarbadi": {fullName:"Jaffrabadi Buffalo", origin:"Gujarat, India", lifespan:"14-18 years", milkYield:"6-10 L/day", description:"Large buffalo, high milk yield."},
  "jersey": {fullName:"Jersey Cow", origin:"Jersey Island, UK", lifespan:"18-22 years", milkYield:"12-20 L/day", description:"Rich milk producer."},
  "murrah": {fullName:"Murrah Buffalo", origin:"Haryana, India", lifespan:"16-20 years", milkYield:"8-12 L/day", description:"High milk-producing buffalo."},
  "nili ravi": {fullName:"Nili Ravi Buffalo", origin:"Pakistan", lifespan:"14-18 years", milkYield:"7-12 L/day", description:"Famous dairy buffalo breed."},
  "red sindhi": {fullName:"Red Sindhi Cow", origin:"Sindh (Pakistan/India)", lifespan:"12-15 years", milkYield:"8-12 L/day", description:"Good milk yield, heat-tolerant."},
  "sahiwal": {fullName:"Sahiwal Cow", origin:"Punjab region", lifespan:"12-15 years", milkYield:"12-18 L/day", description:"Heat-tolerant dairy breed."},
  "pandharpuri": {fullName:"Pandharpuri Cow", origin:"Maharashtra, India", lifespan:"12-15 years", milkYield:"5-8 L/day", description:"Adapted to drought regions."},
  "sirohi": {fullName:"Sirohi Goat", origin:"Rajasthan, India", lifespan:"10-12 years", milkYield:"1-2 L/day", description:"Good meat and milk-producing goat."},
  "Not Identified": {fullName:"Not Identified", origin:"-", lifespan:"-", milkYield:"-", description:"Breed could not be identified."}
};

// Logging
function log(msg){ logs.textContent += msg+"\n"; logs.scrollTop = logs.scrollHeight; }

// Camera setup
async function startCamera(){
  try{
    const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:"environment" }, audio:false });
    video.srcObject = stream;
    await video.play();
  }catch(e){ log("Camera error: "+e); }
}

// Preprocess frame: center crop, normalize brightness
function preprocessFrame(){
  const w = video.videoWidth;
  const h = video.videoHeight;
  const size = Math.min(w,h);
  const sx = (w-size)/2, sy=(h-size)/2;

  canvas.width = 224;
  canvas.height = 224;
  ctx.drawImage(video, sx, sy, size, size, 0, 0, 224, 224);

  const imgData = ctx.getImageData(0,0,224,224);
  const data = imgData.data;
  let sum=0;
  for(let i=0;i<data.length;i+=4){
    sum += 0.299*data[i]+0.587*data[i+1]+0.114*data[i+2];
  }
  const avg = sum/(224*224);
  const factor = 128/avg;
  for(let i=0;i<data.length;i+=4){
    data[i]=Math.min(255,data[i]*factor);
    data[i+1]=Math.min(255,data[i+1]*factor);
    data[i+2]=Math.min(255,data[i+2]*factor);
  }
  ctx.putImageData(imgData,0,0);

  return new Promise(resolve=>canvas.toBlob(blob=>resolve(blob),"image/jpeg",0.9));
}

// Detection API
async function detectCattle(blob){
  try{
    const form = new FormData();
    form.append("file", blob, "frame.jpg");
    const res = await fetch("https://rjsmoke00-cd.hf.space/predict",{method:"POST",body:form});
    const data = await res.json();
    return (data.prediction === "LABEL_1");
  }catch(e){ log("Detection API error: "+e.message); return false; }
}

// Breed API
async function detectBreed(blob){
  try{
    const form = new FormData();
    form.append("file", blob, "frame.jpg");
    const res = await fetch("https://Shivangguptasih-hf.hf.space/predict",{method:"POST",body:form});
    const data = await res.json();
    let label = data.prediction || "Not Identified";
    label = label.toLowerCase();
    const match = CLASSES.find(c=>label.includes(c.replace(/ /g,''))) || "Not Identified";
    return match;
  }catch(e){ log("Breed API error: "+e.message); return "Not Identified"; }
}

// Show result
function showResult(breed){
  const info = breedInfo[breed] || breedInfo["Not Identified"];
  breedNameEl.textContent = `Breed: ${info.fullName}`;
  originEl.textContent = `Origin: ${info.origin}`;
  lifespanEl.textContent = `Lifespan: ${info.lifespan}`;
  milkYieldEl.textContent = `Milk Yield: ${info.milkYield}`;
  descriptionEl.textContent = `About: ${info.description}`;
  resultDiv.style.display="block";
  scanAgainBtn.style.display="inline-block";
}

// Live scanning with multiple-frame voting
async function liveScan(){
  if(requestInProgress) return;
  requestInProgress=true;

  const votes = {};
  const framesToVote = 5;
  let detectedCattle = false;

  for(let i=0;i<framesToVote;i++){
    const blob = await preprocessFrame();
    const detected = await detectCattle(blob);
    log(`Cattle detected: ${detected}`);
    if(detected){
      detectedCattle = true;
      const breed = await detectBreed(blob);
      log(`Breed detected: ${breed}`);
      votes[breed] = (votes[breed]||0)+1;
    }
    await new Promise(r=>setTimeout(r,200)); // small delay between frames
  }

  let finalBreed="Not Identified";
  if(detectedCattle){
    let maxCount=0;
    for(const b in votes){
      if(votes[b]>maxCount){ maxCount=votes[b]; maxCount=votes[b]; finalBreed=b; }
    }
  }

  showResult(finalBreed);
  requestInProgress=false;
}

// Scan again
scanAgainBtn.addEventListener("click",()=>{
  resultDiv.style.display="none";
  scanAgainBtn.style.display="none";
  liveScan();
});

// Start camera and scan
startCamera().then(liveScan);
</script>
</body>
</html>
